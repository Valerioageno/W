W={sprite_count:0,plane_count:0,cube_count:0,pyramid_count:0,objects1:{},objects2:{},compile:r=>{var e=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(e,"attribute vec4 position;attribute vec4 color;attribute vec4 normal;uniform mat4 mvp;uniform float mvpfactor;uniform mat4 model;uniform mat4 inverseTranspose;varying vec4 v_color;varying vec3 v_normal;varying vec3 v_position;void main(){gl_Position=mvp*position;v_position=vec3(model*position);v_normal=normalize(vec3(inverseTranspose*normal));v_color=color;}"),gl.compileShader(e);var a=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(a,"precision mediump float;uniform vec3 lightDirection;varying vec3 v_normal;varying vec3 v_position;varying vec4 v_color;void main(){float nDotL=max(dot(lightDirection,v_normal),0.0);vec3 diffuse=v_color.rgb*nDotL;vec3 ambient=0.2*v_color.rgb;gl_FragColor=vec4(diffuse+ambient,1.0);}"),gl.compileShader(a),W.program=gl.createProgram(),gl.attachShader(W.program,e),gl.attachShader(W.program,a),gl.linkProgram(W.program),gl.useProgram(W.program)},buffer:(r,e,a,t,n,o)=>{r.bindBuffer(r.ARRAY_BUFFER,r.createBuffer()),r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW);var l=r.getAttribLocation(a,t);r.vertexAttribPointer(l,n,o,!1,0,0),r.enableVertexAttribArray(l)},transpose:r=>new DOMMatrix([r.m11,r.m21,r.m31,r.m41,r.m12,r.m22,r.m32,r.m42,r.m13,r.m23,r.m33,r.m43,r.m14,r.m24,r.m34,r.m44]),rgb:r=>[+("0x"+r[1])/16,+("0x"+r[2])/16,+("0x"+r[3])/16],lerp:r=>{var e=W.objects1[W.name],a=W.objects2[W.name];return a.f<a.t?e[r]+(a[r]-e[r])*(a.f/a.t):a[r]},transition:r=>{r.translateSelf(W.lerp("x"),W.lerp("y"),W.lerp("z")).rotateSelf(W.lerp("rx"),0,0).rotateSelf(0,W.lerp("ry"),0).rotateSelf(0,0,W.lerp("rz")),"cam"!=W.name&&r.scaleSelf(W.lerp("w"),W.lerp("h"),W.lerp("d"))},init:r=>{var e=W.objects1[r.n]=W.objects2[r.n]||{};r.g=r.g||e.g||"scene",r.type=r.type||e.type,r.b=r.b||e.b||"#888",r.w=r.w||e.w||0,r.h=r.h||e.h||0,r.d=r.d||e.d||1,r.x=r.x||0===r.x?r.x:e.x||0,r.y=r.y||0===r.y?r.y:e.y||0,r.z=r.z||0===r.z?r.z:e.z||0,r.rx=r.rx||0===r.rx?r.rx:e.rx||0,r.ry=r.ry||0===r.ry?r.ry:e.ry||0,r.rz=r.rz||0===r.rz?r.rz:e.rz||0,r.t||=1,r.f=0,W.objects2[r.n]=r},plane:r=>{r.n||(r.n="plane"+W.plane_count++),r.type="plane",W.init(r)},cube:r=>{r.n||(r.n="plane"+W.cube_count++),r.type="cube",W.init(r)},pyramid:r=>{r.n||(r.n="plane"+W.pyramid_count++),r.type="pyramid",W.init(r)},move:r=>{W.init(r)},camera:r=>{r.n="cam",W.init(r)},light:r=>{r.n="light",W.init(r)},draw:r=>{gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);var e,t,n,o=new DOMMatrix([1/Math.tan(.5)/(a.width/a.height),0,0,0,0,1/Math.tan(.5),0,0,0,0,1001/-999,-1,0,0,2e3/-999,0]);for(var l in W.name="cam",W.transition(o),W.objects2){W.objects1[l];var i=W.objects2[l];if(i.f<i.t&&i.f++,i.type){if("plane"==i.type)e=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),t=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1]),n=new Uint16Array([0,1,2,0,2,3]);else if("cube"==i.type)e=new Float32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1]),t=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),n=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);else if("pyramid"==i.type){var g=3**.5;e=new Float32Array([-1,0,1,1,0,1,0,g,0,1,0,1,1,0,-1,0,g,0,1,0,-1,-1,0,-1,0,g,0,-1,0,-1,-1,0,1,0,g,0,-1,0,1,-1,0,-1,1,0,1,-1,0,-1,1,0,-1,1,0,1]),t=new Float32Array([0,-1,g,0,-1,g,0,-1,g,g,-1,0,g,-1,0,g,-1,0,0,-1,-g,0,-1,-g,0,-1,-g,-g,-1,0,-g,-1,0,-g,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0]),n=new Uint16Array([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17])}var m=n.length;W.buffer(gl,e,W.program,"position",3,gl.FLOAT),W.buffer(gl,t,W.program,"normal",3,gl.FLOAT);var c=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,c),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,n,gl.STATIC_DRAW);var p=gl.getAttribLocation(W.program,"color");gl.vertexAttrib3fv(p,W.rgb(i.b));var v=gl.getUniformLocation(W.program,"model"),f=gl.getUniformLocation(W.program,"mvp"),s=gl.getUniformLocation(W.program,"inverseTranspose"),y=gl.getUniformLocation(W.program,"lightDirection"),b=new DOMMatrix;W.name=i.n,W.transition(b),gl.uniformMatrix4fv(v,!1,b.toFloat32Array());var u=new DOMMatrix(b);u.preMultiplySelf(o),gl.uniformMatrix4fv(f,!1,u.toFloat32Array());var _=new DOMMatrix(b);_=W.transpose(_.invertSelf()),gl.uniformMatrix4fv(s,!1,_.toFloat32Array()),W.name="light",gl.uniform3f(y,W.lerp("x"),W.lerp("y"),W.lerp("z")),gl.drawElements(gl.TRIANGLES,m,gl.UNSIGNED_SHORT,0)}}}},gl=a.getContext("webgl"),W.compile(),gl.clearColor(1,1,1,1),gl.enable(gl.DEPTH_TEST),W.light({z:1}),W.camera({}),setInterval(W.draw,16);