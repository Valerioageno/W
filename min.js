W={models:{},renderers:{},reset:e=>{W.lastFrame=0,W.objs=0,W.current={},W.next={},W.textures={},W.perspective=new DOMMatrix([1/Math.tan(.5)/(e.width/e.height),0,0,0,0,1/Math.tan(.5),0,0,0,0,901/-899,-1,0,0,1800/-899,0]),W.gl=e.getContext("webgl2"),W.gl.blendFunc(770,771),W.gl.activeTexture(33984),W.program=W.gl.createProgram(),W.gl.shaderSource(t=W.gl.createShader(35633),"#version 300 es\nuniform mat4 pv,eye,m;uniform vec4 bb;out vec4 v_pos,v_col,v_uv;void main(){gl_Position=pv*(v_pos=bb.z>0.?m[3]-eye*(pos*bb):m*pos);v_col=col,v_uv=uv;}"),W.gl.compileShader(t),W.gl.attachShader(W.program,t),,W.gl.shaderSource(t=W.gl.createShader(35632),"#version 300 es\nin vec4 v_pos,v_col,v_uv;uniform vec3 light;uniform sampler2D sampler;out vec4 c;void main(){c=v_col.a>0.?v_col:texture(sampler,v_uv.xy);c=vec4(c.rgb*(max(dot(light,normalize(cross(dFdx(v_pos.xyz),dFdy(v_pos.xyz)))),0.)+.2),c.a);}"),W.gl.compileShader(t),W.gl.attachShader(W.program,t),,W.gl.linkProgram(W.program),W.gl.useProgram(W.program),W.gl.clearColor(1,1,1,1),W.gl.enable(2929),W.light({z:1}),W.camera({}),W.draw()},lerp:(e,r)=>W.next[e]?.t?W.current[e][r]+(W.next[e][r]-W.current[e][r])*(W.next[e].f/W.next[e].t):W.next[e][r],transition:e=>W.next[e]?(new DOMMatrix).translateSelf(W.lerp(e,"x"),W.lerp(e,"y"),W.lerp(e,"z")).rotateSelf(W.lerp(e,"rx"),W.lerp(e,"ry"),W.lerp(e,"rz")).scaleSelf(W.lerp(e,"w"),W.lerp(e,"h"),W.lerp(e,"d")):new DOMMatrix,setState:(e,r,t)=>{e.n||="o"+W.objs++,e.b&&e.b.id&&e.b.width&&!W.textures[e.b.id]&&(t=W.gl.createTexture(),W.gl.pixelStorei(37441,!0),W.gl.bindTexture(3553,t),W.gl.pixelStorei(37440,1),W.gl.texImage2D(3553,0,6408,6408,5121,e.b),W.gl.generateMipmap(3553),W.textures[e.b.id]=t),e={type:r,...W.current[e.n]=W.next[e.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"000"},...e},e.t||=0,e.f=0,W.next[e.n]=e},group:e=>W.setState(e,"group"),move:e=>W.setState(e),delete:e=>delete W.n[e.n],camera:e=>W.setState(e,e.n="camera"),light:e=>W.setState(e,e.n="light"),draw:(e,r,t,o,a,l,n,i,g=[])=>{for(a in n=e-W.lastFrame,W.lastFrame=e,requestAnimationFrame(W.draw),W.gl.clear(16640),t=new DOMMatrix,t=W.transition("camera"),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"eye"),!1,t.toFloat32Array()),t.invertSelf(),t.preMultiplySelf(W.perspective),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"pv"),!1,t.toFloat32Array()),W.next)W.next[a].b.id||W.next[a].b[3]?g.push(W.next[a]):W.render(W.next[a],n);for(a in g.sort(((e,r)=>e.m&&r.m&&W.dist(r.m,W.next.camera.m)-W.dist(e.m,W.next.camera.m))),W.gl.enable(3042),g)W.render(g[a],n);W.gl.disable(3042)},render:(e,r,t,o,a)=>{W.models[e.type]?.vertices&&!W.models?.[e.type].verticesBuffer&&(W.gl.bindBuffer(34962,W.models[e.type].verticesBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[e.type].vertices),35044)),W.models[e.type]?.uv&&!W.models[e.type].uvBuffer&&(W.gl.bindBuffer(34962,W.models[e.type].uvBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[e.type].uv),35044)),e.b.id&&(W.gl.bindTexture(3553,W.textures[e.b.id]),W.gl.uniform1i(W.gl.getUniformLocation(W.program,"sampler"),0)),e.f<e.t&&(e.f+=r),e.f>e.t&&(e.f=e.t),W.next[e.n].m=W.transition(e.n),W.next[e.g]&&W.next[e.n].m.preMultiplySelf(W.next[e.g].m),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"m"),!1,W.next[e.n].m.toFloat32Array()),["camera","light","group"].includes(e.type)||(W.gl.bindBuffer(34962,W.models[e.type].verticesBuffer),W.gl.vertexAttribPointer(a=W.gl.getAttribLocation(W.program,"pos"),3,5126,!1,0,0),W.gl.enableVertexAttribArray(a),W.models[e.type].uvBuffer&&(W.gl.bindBuffer(34962,W.models[e.type].uvBuffer),W.gl.vertexAttribPointer(a=W.gl.getAttribLocation(W.program,"uv"),2,5126,!1,0,0),W.gl.enableVertexAttribArray(a)),W.gl.vertexAttrib4fv(W.gl.getAttribLocation(W.program,"col"),e.b.id?[0,0,0,0]:[...[...e.b].map((e=>("0x"+e)/16)),e.b.id?0:1]),W.gl.uniform3f(W.gl.getUniformLocation(W.program,"light"),W.lerp("light","x"),W.lerp("light","y"),W.lerp("light","z")),W.gl.uniform4f(W.gl.getUniformLocation(W.program,"bb"),e.w,e.h,"billboard"==e.type,0),W.gl.drawArrays(4,0,W.models[e.type].vertices.length/3))},dist:(e,r)=>(r.m41-e.m41)**2+(r.m42-e.m42)**2+(r.m43-e.m43)**2},W.models.plane=W.models.billboard={vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,0,0,0,0,1,1,0,0,1,1,1]},W.plane=e=>W.setState(e,"plane"),W.billboard=e=>W.setState(e,"billboard"),W.models.cube={vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]},W.cube=e=>W.setState(e,"cube"),W.models.pyramid={vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,0,0,0,0,1,1,0,0,1,1,1]},W.pyramid=e=>W.setState(e,"pyramid"),W.renderers.triangles=()=>{},W.renderers.lines=()=>{}