<!doctype html>
<script src="parse.js"></script>
<h2>obj / mtl to WebGL buffer converter</h2>
<b>OBJ file</b>: <button id=mario>Mario</button> <button id=yoshi>Yoshi</button> <button id=coin>Coin block</button> or <input type=file id=obj>
<p><b>Options</b>: float range <input type=number value=10 id=scale onchange="convert()" oninput="convert()" min=1>, 
max decimals (vertices): <input type=number value=4 id=round1 onchange="convert()" oninput="convert()" min=0 max=10>, 
max decimals (textures): <input type=number value=4 id=round2 onchange="convert()" oninput="convert()" min=1 max=10>,
Unicode precision: <input type=number value=127 id=unicode onchange="convert()" oninput="convert()" min=1>
<img src="mario.png" id=texture hidden>
<p>
<table>
<tr><th>Unindexed: floats (<i id=out1i>0 bytes</i>)<th>Unicode (<i id=out2i>0 chars</i>)
<tr><td><textarea id=out1 rows=20></textarea><td><textarea id=out2 rows=20></textarea>
<tr><th>Indexed: floats (<i id=out3i>0 bytes</i>)<th>Unicode (<i id=out4i>0 chars</i>)
<tr><td><textarea id=out3 rows=20></textarea><td><textarea id=out4 rows=20></textarea>
<tr><th colspan=2>Preview: floats / Unicode
<tr><td colspan=2><center><canvas id=a width=700 height=300></canvas>
</table>

<script>
gl = a.getContext("webgl2");
convert = () => {
  W.reset();

  texture.src=name + ".png";
  texture.onload = texture.onerror = e => {
  
  //console.log(file);
    
    parseOBJ(file).then(x=>{
      size = x[1].size;
      //console.log(x[0]);
      //console.log(z=x);
      out1.innerHTML = `gl.bindBuffer(34962, W.vertices["${name}"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([`;
      out1.innerHTML += x[0].groups[0].v.map(x=>+((x*scale.value/size).toFixed(round1.value))).join(",");
      out1.innerHTML += `].map(x=>x/${scale.value})), 35044); 
  gl.bindBuffer(34962, W.texCoords["${name}"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([`;
      out1.innerHTML += x[0].groups[0].vt.map(x=>+((x).toFixed(round2.value))).join(",");
      out1.innerHTML += `]), 35044);
  W["${name}"]=t=>{t.T="${name}";W.i(t)}`;
      out1i.innerHTML = new Intl.NumberFormat("en-US").format(out1.innerHTML.length) + " bytes";
      out1.innerHTML = out1.innerHTML.replace(/(\D)0\./g,"$1.");
      
      
      
      out2.innerHTML = `gl.bindBuffer(34962, W.vertices["${name}_txt"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([...
    '`;
      out2.innerHTML += x[0].groups[0].v.flat().map(x=>String.fromCodePoint((x*unicode.value/size).toFixed(0)).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\0/g,"\u0001")).join("");
      out2.innerHTML += `'
  ].map(a=>(a.codePointAt())/${unicode.value})
  ), 35044); 
  gl.bindBuffer(34962, W.texCoords["${name}_txt"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([...
    '`;
      out2.innerHTML += x[0].groups[0].vt.flat().map(x=>String.fromCharCode((x*unicode.value).toFixed(0)).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\0/g,"\u0001")).join("");
      out2.innerHTML += `'
  ].map(a=>(a.codePointAt())/${unicode.value})
  ), 35044);
  W["${name}_txt"]=t=>{t.T="${name}_txt";W.i(t)}`;
      out2i.innerHTML = new Intl.NumberFormat("en-US").format(out2.innerHTML.length) + " chars";
      
      /*out2.innerHTML = "vertices=[";
      out2.innerHTML += x[1].v.flat().map(x=>+((x*scale.value).toFixed(round1.value))).join(",");
      out2.innerHTML += "]\nverticesIndices=[";
      out2.innerHTML += x[0].groups[0].vi.map(x=>+x).join(",");
      out2.innerHTML += "]\ntexCoords=[";
      out2.innerHTML += x[1].vt.flat().map(x=>+((x).toFixed(round2.value))).join(",");
      out2.innerHTML += "]\ntexCoordsIndices=[";
      out2.innerHTML += x[0].groups[0].vti.map(x=>+x).join(",");
      out2.innerHTML += "]";
      out2.innerHTML = out2.innerHTML.replace(/(\D)0\./g,"$1.");
      out2i.innerHTML = out2.innerHTML.length + " bytes";*/
      
      
      //console.log(out1.value);
      eval(out1.value);
      eval(out2.value);
      //console.log(W.mario);
      W.camera({x:0,z:0});
      W.light({x:.1,y:-.3,z:.3});
      W.group({n:"g1", x:.3, y:1});
      W.group({n:"g2", x:1.1, y:1});
      W[name]({n:"obj1",g:"g1",x:-35,y:-35,z:-35,w:70,h:70,d:70,b:e.type == "error" ? "777" : texture});
      W[name+"_txt"]({n:"obj2",g:"g2",x:-35,y:-35,z:-35,w:70,h:70,d:70,b:e.type == "error" ? "777" : texture});
      W.move({n:"g1",rx:3600,rz:3600,t:100});
      W.move({n:"g2",rx:3600,rz:3600,t:100});
      
    
    })

  }

}

mario.onclick = async () => {
  name = "mario";
  file = await(await fetch("mario.obj")).text();
  convert();
}

yoshi.onclick = async () => {
  name = "yoshi";
  file = await(await fetch("yoshi.obj")).text();
  convert();
}

coin.onclick = async () => {
  name = "coin";
  file = await(await fetch("coin.obj")).text();
  convert();
}

obj.onload = obj.oninput = () => {
  if (obj.files && obj.files[0]) {
    var myFile = obj.files[0];
    var reader = new FileReader();
    
    reader.addEventListener('load', function (e) {
      file = e.target.result;
      name = obj.files[0].name.replace(/\.obj/i,"");
      convert();
    });
    
    reader.readAsBinaryString(myFile);
  }   
}
</script>
<style>
body { font-family: arial; font-size: 11px; }
textarea { width: 47.5vw; height: calc((100vh - 340px - 17em)/2); font-size: 10px;line-height: 9px }
input, button { font-size: 11px; }
#round1, #round2, #scale, #unicode { width: 35px }
canvas { border: 1px solid }
</style>
<script src="../webglframework.js"></script>