<!doctype html>
<script src="parse.js"></script>
<h2>OBJ to WebGL buffer converter</h2>
<b>OBJ file</b>: <button id=mario>Mario</button> <button id=yoshi>Yoshi</button> <button id=coin>Coin block</button>  <button id=cube>Cube</button> or <input type=file id=obj>
<p><b>Options</b>: float range <input type=number value=10 id=scale onchange="convert()" oninput="convert()" min=1>, 
max decimals (vertices): <input type=number value=2 id=round1 onchange="convert()" oninput="convert()" min=0 max=10>, 
max decimals (textures): <input type=number value=2 id=round2 onchange="convert()" oninput="convert()" min=1 max=10>,
Unicode precision: <input type=number value=127 id=unicode onchange="convert()" oninput="convert()" min=1>
<img src="mario.png" id=texture hidden>
<p>
<table>
<tr><th>Unindexed: original (<i id=outoriginali>0 bytes</i>)<th>floats (<i id=out1i>0 bytes</i>)<th>Unicode (<i id=out2i>0 bytes</i>)
<tr><td><textarea id=outoriginal rows=20></textarea><td><textarea id=out1 rows=20></textarea><td><textarea id=out2 rows=20></textarea>
<tr><th>Indexed: original (<i id=outoriginalindexedi>0 bytes</i>)<th>floats (<i id=out3i>0 bytes</i>)<th>Unicode (<i id=out4i>0 bytes</i>)
<tr><td><textarea id=outoriginalindexed rows=20></textarea><td><textarea id=out3 rows=20></textarea><td><textarea id=out4 rows=20></textarea>
<tr><th colspan=3>Preview: floats / Unicode
<tr><td colspan=3><center><canvas id=a width=900 height=350></canvas>
</table>
<center>Original = direct copy of the OBJ values. Floats / Unicode = centered vertices + lossy compression

<script>
gl = a.getContext("webgl2");
convert = () => {
  W.reset(a);

  texture.src=name + ".png";
  texture.onload = texture.onerror = e => {
  
  //console.log(file);
    
    parseOBJ(file).then(x=>{
      size = x[1].size;
      console.log(z=x, +scale.value, size);
      
      
      
      
      outoriginal.innerHTML = `W.models["${name}_original"] = {
  vertices: [${x[0].groups[0].originalv.map(x=>+x).join(",")}]${x[0].groups[0].vt.length ? (",\n  uv: [" + x[0].groups[0].vt.map(x=>+x).join(",") + "]") : ""}
};
W["${name}_original"] = settings => W.setState(settings, "${name}_original");`;
      outoriginal.innerHTML = outoriginal.innerHTML.replace(/(\D)0\./g,"$1.");
      outoriginali.innerHTML = new Intl.NumberFormat("en-US").format(outoriginal.innerHTML.length) + " bytes";
      
      
      
      // original, centered and resized for the demo
      originalcentered = `W.models["${name}_original"] = {
  vertices: [${x[0].groups[0].v.map(x=>+((x/size))).join(",")}]${x[0].groups[0].vt.length ? (",\n  uv: [" + x[0].groups[0].vt.map(x=>+((x))).join(",") + "]") : ""}
};
W["${name}_original"] = settings => W.setState(settings, "${name}_original");`;
      
      
      
      
      out1.innerHTML = `W.models["${name}"] = {
  vertices: [${x[0].groups[0].v.map(x=>+((x/size).toFixed(round1.value))).join(",")}]${x[0].groups[0].vt.length ? (",\n  uv: [" + x[0].groups[0].vt.map(x=>+((x).toFixed(round2.value))).join(",") + "]") : ""}
};
W["${name}"] = settings => W.setState(settings, "${name}");`;
      out1.innerHTML = out1.innerHTML.replace(/(\D)0\./g,"$1.");
      out1i.innerHTML = new Intl.NumberFormat("en-US").format(out1.innerHTML.length) + " bytes";
      
      
      
      
      out2.innerHTML = `W.models["${name}_txt"] = {
  vertices: [...'${x[0].groups[0].v.flat().map(x=>String.fromCodePoint((x*unicode.value/size).toFixed(0)).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\0/g,"\u0001")).join("")}'].map(a=>(a.codePointAt())/${unicode.value})${x[0].groups[0].vt.length ? (",\n  uv: [...'" + x[0].groups[0].vt.flat().map(x=>String.fromCharCode((x*unicode.value).toFixed(0)).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\0/g,"\u0001")).join("") + "]'].map(a=>(a.codePointAt())/"+unicode.value+")") : ""}
};
W["${name}_txt"] = settings => W.setState(settings, "${name}_txt");`;
      out2i.innerHTML = new Intl.NumberFormat("en-US").format((new TextEncoder().encode(out2.innerHTML)).length) + " bytes";
      
     // TODO
      
     /* 
      
      
      outoriginalindexed.innerHTML = `gl.bindBuffer(34962, W.vertices["${name}_original"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([`;
      outoriginalindexed.innerHTML += x[0].groups[0].indexv.map(x=>+x).join(",");
      outoriginalindexed.innerHTML += `]), 35044);`;
      if(x[0].groups[0].indexvt.length){
      outoriginalindexed.innerHTML += `
  gl.bindBuffer(34962, W.texCoords["${name}_original"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([`;
      outoriginalindexed.innerHTML += x[0].groups[0].indexvt.map(x=>+x).join(",");
      outoriginalindexed.innerHTML += `]), 35044);`;
      }
      outoriginalindexed.innerHTML += `\nW["${name}_original"]=t=>{t.T="${name}_original";W.i(t)}
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, W.indices["${name}_original"] = gl.createBuffer());
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array([`
      outoriginalindexed.innerHTML += x[0].groups[0].indices.map(x=>+x).join(",");
      outoriginalindexed.innerHTML += `]), gl.STATIC_DRAW);`;
      outoriginalindexed.innerHTML = outoriginalindexed.innerHTML.replace(/(\D)0\./g,"$1.");
      outoriginalindexedi.innerHTML = new Intl.NumberFormat("en-US").format(outoriginalindexed.innerHTML.length) + " bytes";
      
      
      
      
      
      out3.innerHTML = `gl.bindBuffer(34962, W.vertices["${name}"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([`;
      out3.innerHTML += x[0].groups[0].indexv.map(x=>+((x*scale.value/size).toFixed(round1.value))).join(",");
      out3.innerHTML += `].map(x=>x/${scale.value}-.5)), 35044);`;
      if(x[0].groups[0].indexvt.length){
      out3.innerHTML += `
  gl.bindBuffer(34962, W.texCoords["${name}"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([`;
      out3.innerHTML += x[0].groups[0].indexvt.map(x=>+((x).toFixed(round2.value))).join(",");
      out3.innerHTML += `]), 35044);`;
      }
      out3.innerHTML += `\nW["${name}"]=t=>{t.T="${name}";W.i(t)}
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, W.indices["${name}"] = gl.createBuffer());
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array([`
      out3.innerHTML += x[0].groups[0].indices.map(x=>+x).join(",");
      out3.innerHTML += `]), gl.STATIC_DRAW);`;
      out3.innerHTML = out3.innerHTML.replace(/(\D)0\./g,"$1.");
      out3i.innerHTML = new Intl.NumberFormat("en-US").format(out3.innerHTML.length) + " bytes";
     
     
      out4.innerHTML = `gl.bindBuffer(34962, W.vertices["${name}_txt"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([...`;
      out4.innerHTML += x[0].groups[0].indexv.map(x=>String.fromCharCode((x*unicode.value/size).toFixed(0)).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\0/g,"\u0001")).join("");
      out4.innerHTML += `'
  ].map(a=>(a.codePointAt())/${unicode.value}-.5)
  ), 35044);`;
      if(x[0].groups[0].indexvt.length){
      out4.innerHTML += `
  gl.bindBuffer(34962, W.texCoords["${name}_txt"] = gl.createBuffer());
  gl.bufferData(34962, new Float32Array([...`;
      
      out4.innerHTML += x[0].groups[0].indexvt.map(x=>String.fromCharCode((x*unicode.value).toFixed(0)).replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\0/g,"\u0001")).join("");
      
      out4.innerHTML += `'
  ].map(a=>(a.codePointAt())/${unicode.value})
  ), 35044);`;
      }
      out4.innerHTML += `\nW["${name}_txt"]=t=>{t.T="${name}_txt";W.i(t)}
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, W.indices["${name}_txt"] = gl.createBuffer());
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array([...`
      
      out4.innerHTML += x[0].groups[0].indices.map(x=>String.fromCodePoint(x)).join("");
      
      out4.innerHTML += `].map(a=>a.codePointAt())), gl.STATIC_DRAW);`;
      out4.innerHTML = out4.innerHTML.replace(/(\D)0\./g,"$1.");
      out4i.innerHTML = new Intl.NumberFormat("en-US").format((new TextEncoder().encode(out4.innerHTML)).length) + " bytes";
      */
      //console.log(out1.value);
      eval(originalcentered);
      eval(out1.value);
      eval(out2.value);
      //console.log(W.mario);
      W.camera({x:0,z:50});
      W.light({x:0,y:.8,z:.8});
      W.group({n:"g0", x:-45});
      W.group({n:"g1", x:0});
      W.group({n:"g2", x:45});
      W[name+"_original"]({n:"obj0",g:"g0",x:-15,y:-15,z:-15,w:30,h:30,d:30,b:e.type == "error" ? "777" : texture});
      W[name]({n:"obj1",g:"g1",x:-15,y:-15,z:-15,w:30,h:30,d:30,b:e.type == "error" ? "777" : texture});
      W[name+"_txt"]({n:"obj2",g:"g2",x:-15,y:-15,z:-15,w:30,h:30,d:30,b:e.type == "error" ? "777" : texture});
      //setTimeout(()=>{
        W.move({n:"g0",rx:360,rz:360,t:10000});
        W.move({n:"g1",rx:360,rz:360,t:10000});
        W.move({n:"g2",rx:360,rz:360,t:10000});
      //},100);
    })

  }

}

mario.onclick = async () => {
  name = "mario";
  file = await(await fetch("mario.obj")).text();
  convert();
}

yoshi.onclick = async () => {
  name = "yoshi";
  file = await(await fetch("yoshi.obj")).text();
  convert();
}

coin.onclick = async () => {
  name = "coin";
  file = await(await fetch("coin.obj")).text();
  convert();
}

cube.onclick = async () => {
  name = "cubeobj";
  file = await(await fetch("cube.obj")).text();
  convert();
}

obj.onload = obj.oninput = () => {
  if (obj.files && obj.files[0]) {
    var myFile = obj.files[0];
    var reader = new FileReader();
    
    reader.addEventListener('load', function (e) {
      file = e.target.result;
      name = obj.files[0].name.replace(/\.obj/i,"");
      convert();
    });
    
    reader.readAsBinaryString(myFile);
  }   
}
</script>
<style>
body { font-family: arial; font-size: 11px; }
textarea { width: 31vw; height: calc((100vh - 390px - 17em)/2); font-size: 10px;line-height: 9px }
input, button { font-size: 11px; }
#round1, #round2, #scale, #unicode { width: 35px }
canvas { border: 1px solid }
</style>
<script src="../webglframework.js"></script>