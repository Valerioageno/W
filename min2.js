W=((e,r,t,o,l,a,i,n,g,s,m)=>{return i=(e,r,l,c,d=[])=>{for(c in r=e-o,o=e,requestAnimationFrame(i),W.gl.clear(16640),l=s("camera"),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"eye"),!1,l.toFloat32Array()),l.invertSelf(),l.preMultiplySelf(a),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"pv"),!1,l.toFloat32Array()),W.gl.uniform3f(W.gl.getUniformLocation(W.program,"light"),g("light","x"),g("light","y"),g("light","z")),t)t[c].b.id||t[c].b[3]?d.push(t[c]):n(t[c],r);for(c in d.sort(((e,r)=>m(r)-m(e))),W.gl.enable(3042),d)n(d[c],r);W.gl.disable(3042)},n=(e,r,o)=>{e.b.id&&(W.gl.bindTexture(3553,l[e.b.id]),W.gl.uniform1i(W.gl.getUniformLocation(W.program,"sampler"),0)),e.f<e.t&&(e.f+=r),e.f>e.t&&(e.f=e.t),t[e.n].m=s(e.n),t[e.g]&&t[e.n].m.preMultiplySelf(t[e.g].m),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"m"),!1,(t[e.n].M||t[e.n].m).toFloat32Array()),["camera","light","group"].includes(e.type)||(W.gl.bindBuffer(34962,W.models[e.type].verticesBuffer),W.gl.vertexAttribPointer(o=W.gl.getAttribLocation(W.program,"pos"),3,5126,!1,0,0),W.gl.enableVertexAttribArray(o),W.models[e.type].uvBuffer&&(W.gl.bindBuffer(34962,W.models[e.type].uvBuffer),W.gl.vertexAttribPointer(o=W.gl.getAttribLocation(W.program,"uv"),2,5126,!1,0,0),W.gl.enableVertexAttribArray(o)),W.gl.uniform4f(W.gl.getUniformLocation(W.program,"bb"),e.w,e.h,"billboard"==e.type,0),W.renderers[e.r||"triangles"](e))},g=(e,o)=>t[e]?.t?r[e][o]+(t[e][o]-r[e][o])*(t[e].f/t[e].t):t[e][o],s=(e,r=new DOMMatrix)=>t[e]?r.translateSelf(g(e,"x"),g(e,"y"),g(e,"z")).rotateSelf(g(e,"rx"),g(e,"ry"),g(e,"rz")).scaleSelf(g(e,"w"),g(e,"h"),g(e,"d")):r,m=(e,r=t.camera)=>e&&r?(r.m.m41-e.m.m41)**2+(r.m.m42-e.m.m42)**2+(r.m.m43-e.m.m43)**2:0,{models:{},renderers:{},reset:(o,n)=>{e=0,r={},t={},l={},a=new DOMMatrix([1/Math.tan(.5)/(o.width/o.height),0,0,0,0,1/Math.tan(.5),0,0,0,0,901/-899,-1,0,0,1800/-899,0]),W.gl=o.getContext("webgl2"),W.gl.blendFunc(770,771),W.gl.activeTexture(33984),W.program=W.gl.createProgram(),W.gl.shaderSource(n=W.gl.createShader(35633),"#version 300 es\nprecision highp float;in vec4 pos,col,uv;uniform mat4 pv,eye,m;uniform vec4 bb;out vec4 v_pos,v_col,v_uv;void main(){gl_Position=pv*(v_pos=bb.z>0.?m[3]-eye*(pos*bb):m*pos);v_col=col,v_uv=uv;}"),W.gl.compileShader(n),W.gl.attachShader(W.program,n),W.gl.shaderSource(n=W.gl.createShader(35632),"#version 300 es\nprecision highp float;in vec4 v_pos,v_col,v_uv;uniform vec3 light;uniform sampler2D sampler;out vec4 c;void main(){c=v_col.a>0.?v_col:texture(sampler,v_uv.xy);c=vec4(c.rgb*(max(dot(light,normalize(cross(dFdx(v_pos.xyz),dFdy(v_pos.xyz)))),0.)+.2),c.a);}"),W.gl.compileShader(n),W.gl.attachShader(W.program,n),W.gl.linkProgram(W.program),W.gl.useProgram(W.program),W.gl.clearColor(1,1,1,1),W.gl.enable(2929),console.log("reset",r),W.light({z:1}),W.camera({}),i()},setState:(o,a,i,n,g,s,m,c,d,p,f)=>{o.n||="o"+e++,o.b&&o.b.id&&o.b.width&&!l[o.b.id]&&(i=W.gl.createTexture(),W.gl.pixelStorei(37441,!0),W.gl.bindTexture(3553,i),W.gl.pixelStorei(37440,1),W.gl.texImage2D(3553,0,6408,6408,5121,o.b),W.gl.generateMipmap(3553),l[o.b.id]=i),o={type:a,...r[o.n]=t[o.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888"},...o,f:0},W.models[o.type]?.vertices&&!W.models?.[o.type].verticesBuffer&&(W.gl.bindBuffer(34962,W.models[o.type].verticesBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[o.type].vertices),35044)),W.models[o.type]?.uv&&!W.models[o.type].uvBuffer&&(W.gl.bindBuffer(34962,W.models[o.type].uvBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[o.type].uv),35044)),t[o.n]=o},group:e=>W.setState(e,"group"),move:(e,r)=>setTimeout((()=>{W.setState(e)}),r||1),delete:(e,r)=>setTimeout((()=>{delete t[e.n]}),r||1),camera:(e,r)=>setTimeout((()=>{W.setState(e,e.n="camera")}),r||1),light:(e,r)=>r?setTimeout((()=>{W.setState(e,e.n="light")}),r):W.setState(e,e.n="light")}})();W.renderers.triangles=e=>{W.gl.vertexAttrib4fv(W.gl.getAttribLocation(W.program,"col"),e.b.id?[0,0,0,0]:[...[...e.b].map((e=>("0x"+e)/16)),e.b.id?0:1]),W.gl.drawArrays(4,0,W.models[e.type].vertices.length/3)}